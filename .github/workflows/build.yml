name: CI â€” CMake build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repository
        uses: actions/checkout@v4



      - name: Download and extract gcc-15
        shell: bash
        run: |
          # URL of the .tar.xz to download
          ARCHIVE_URL="https://github.com/Silverlan/test_gcc15/releases/download/2025-11-17/gcc-15.2.0.tar.xz"

          # destination inside the cloned repo (create if needed)
          DEST_DIR="gcc-15"
          mkdir -p "$DEST_DIR"

          # download to a temp file
          curl -L -o /tmp/archive.tar.xz "$ARCHIVE_URL"

          # extract with xz decompression (-J); --strip-components=1 removes top-level folder
          tar -xJf /tmp/archive.tar.xz -C "$DEST_DIR" --strip-components=1

          cd gcc-15
          ls

      - name: Set gcc-15 as default
        shell: bash
        run: |
          curDir="$PWD"
          gccDir="$curDir/gcc-15"
          # register main frontends (adjust priority integer if you want different default priority)
          sudo update-alternatives --install /usr/bin/gcc  gcc  $gccDir/bin/gcc  100
          sudo update-alternatives --install /usr/bin/g++  g++  $gccDir/bin/g++  100
          sudo update-alternatives --install /usr/bin/cc   cc   $gccDir/bin/gcc  100
          sudo update-alternatives --install /usr/bin/cpp  cpp  $gccDir/bin/cpp  100
          # optional: gcov, gfortran, c++ etc. if present:
          sudo update-alternatives --install /usr/bin/gcov gcov $gccDir/bin/gcov 100

          echo "$gccDir/lib64" | sudo tee /etc/ld.so.conf.d/gcc-15.conf
          echo "$gccDir/lib"   | sudo tee -a /etc/ld.so.conf.d/gcc-15.conf

          # refresh cache
          sudo ldconfig




      # Install build tools and cmake (apt-get provides a working version).
      - name: Install build dependencies
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Setup cmake
        uses: jwlawson/actions-setup-cmake@v2

      - name: Build Lua
        shell: bash
        run: |
          git clone https://github.com/Silverlan/LuaJIT.git
          cd LuaJIT
          cd src
          make amalg BUILDMODE=dynamic

      - name: Download and extract tar.xz
        shell: bash
        run: |
          # URL of the .tar.xz to download
          ARCHIVE_URL="https://github.com/Silverlan/clang_prebuilt/releases/download/2025-11-16/linux_x64.tar.xz"

          # destination inside the cloned repo (create if needed)
          DEST_DIR="clang"
          mkdir -p "$DEST_DIR"

          # download to a temp file
          curl -L -o /tmp/archive.tar.xz "$ARCHIVE_URL"

          # extract with xz decompression (-J); --strip-components=1 removes top-level folder
          tar -xJf /tmp/archive.tar.xz -C "$DEST_DIR" --strip-components=1

      - name: Clone external repository
        shell: bash
        run: |
          git clone --single-branch --branch feat/cxx_module https://github.com/Silverlan/luabind-deboostified.git luabind

      - name: Copy CMakeLists.txt
        shell: bash
        run: |
          cp CMakeLists.txt luabind/
          # cp CMakeLists2.txt luabind/src/CMakeLists.txt

      - name: Configure and build with CMake
        shell: bash
        run: |
          curDir="$PWD"
          cd luabind
          mkdir -p build
          export CC="$curDir/bin/clang"
          export CXX="$curDir/bin/clang++"
          cmake -S . -B build -G "Ninja Multi-Config" \
            -DCMAKE_BUILD_TYPE=Release -DLUA_INCLUDE_DIR="$curDir/LuaJIT/src" -DLUA_LIBRARIES="$curDir/LuaJIT/src/libluajit-p.so" \
            -DCMAKE_C_COMPILER="$curDir/clang/bin/clang" -DCMAKE_CXX_COMPILER="$curDir/clang/bin/clang++"
          cmake --build build -- -j$(nproc)

